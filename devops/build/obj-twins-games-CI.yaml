# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
  - master

pr:
  branches:
    include: [develop, master, releases/*]
  autoCancel: true

pool:
  vmImage: 'windows-latest'

jobs:
  - job: 'BuildAPI'
    displayName: 'Build API'
    steps:
      - task: UseDotNet@2
        displayName: 'Use .Net Core SDK 3.x'
        inputs:
          version: 3.x

      - task: DotNetCoreCLI@2
        displayName: 'dotnet restore'
        inputs:
          command: 'restore'
          projects: '**/Obj.Twins.Games.Api.csproj'
          feedsToUse: 'select'

      - task: DotNetCoreCLI@2
        displayName: 'dotnet build'
        inputs:
          projects: '**/Obj.Twins.Games.Api.csproj'
          arguments: '--configuration $(BuildConfiguration) --no-restore'

      - task: DotNetCoreCLI@2
        displayName: 'dotnet publish Obj.Twins.Games.Api'
        inputs:
          command: publish
          publishWebProjects: false
          projects: '**/Obj.Twins.Games.Api.csproj'
          arguments: '--configuration $(BuildConfiguration) --output $(Build.ArtifactStagingDirectory)/obj-twins-games-CI/api'
          zipAfterPublish: false

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: Obj.Twins.Games.Api'
        inputs:
          PathtoPublish: '$(Build.ArtifactStagingDirectory)/obj-twins-games-CI/api'
          ArtifactName: 'obj-twins-games-CI_api'      

      - task: CopyFiles@2
        displayName: 'Copy Assets'
        inputs:
          SourceFolder: Backend/Assets
          TargetFolder: '$(build.artifactstagingdirectory)\obj-twins-games-CI\assets'
          CleanTargetFolder: true

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: Assets'
        inputs:
          PathtoPublish: '$(build.artifactstagingdirectory)\obj-twins-games-CI\assets'
          ArtifactName: 'obj-twins-games-CI_assets'
  - job: 'BuildApp'
    displayName: 'Build App'
    steps:
      - task: NodeTool@0
        displayName: 'Use Node 12.9.x'
        inputs:
          versionSpec: 12.9.x
          checkLatest: true

      - task: Npm@1
        displayName: 'npm install'
        inputs:
          workingDir: frontend/Obj.Twins.Games.App
          verbose: true

      - task: Npm@1
        displayName: 'npm run lint'
        inputs:
          command: custom
          workingDir: frontend/Obj.Twins.Games.App
          verbose: false
          customCommand: 'run lint'
        continueOnError: true
        enabled: false

      - task: Npm@1
        displayName: 'npm run test:prod'
        inputs:
          command: custom
          workingDir: frontend/Obj.Twins.Games.App
          verbose: false
          customCommand: 'run test:prod'

      - task: Npm@1
        displayName: 'npm run build:prod'
        inputs:
          command: custom
          workingDir: frontend/Obj.Twins.Games.App
          verbose: false
          customCommand: 'run build:prod'

      - task: CopyFiles@2
        displayName: 'Copy Files to app'
        inputs:
          SourceFolder: Frontend/Obj.Twins.Games.App/dist
          TargetFolder: '$(build.artifactstagingdirectory)\obj-twins-games-CI\app'
          CleanTargetFolder: true

      - task: PublishBuildArtifacts@1
        displayName: 'Publish Artifact: Obj.Twins.Games.App'
        inputs:
          PathtoPublish: '$(build.artifactstagingdirectory)\obj-twins-games-CI\app'
          ArtifactName: 'obj-twins-games-CI_app'
